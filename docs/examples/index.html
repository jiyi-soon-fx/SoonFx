<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoonFx Engine - æˆ˜æ–—ç³»ç»Ÿæ¼”ç¤º</title>
    <script src="libs/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 8px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 500px;
            gap: 15px;
            height: calc(100vh - 16px);
            overflow: hidden;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            height: 100%;
        }
        
        /* éšè—ä¸»å†…å®¹åŒºåŸŸçš„æ»šåŠ¨æ¡ */
        .main-content::-webkit-scrollbar {
            display: none;
        }
        
        .main-content {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .header {
            background: white;
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 3px;
        }

        .header p {
            color: #666;
            font-size: 0.8em;
        }

        .controls {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .controls h2 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 8px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            font-size: 0.85em;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .output-container {
            background: white;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            height: 100%;
            overflow-y: auto;
        }
        
        /* éšè—è¾“å‡ºå®¹å™¨çš„æ»šåŠ¨æ¡ */
        .output-container::-webkit-scrollbar {
            display: none;
        }
        
        .output-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        .output-container .chart-box {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .output-container h2 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1em;
        }

        #output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.3;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* éšè—è¾“å‡ºæ—¥å¿—çš„æ»šåŠ¨æ¡ */
        #output::-webkit-scrollbar {
            display: none;
        }
        
        #output {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        #output:empty::before {
            content: 'ç­‰å¾…è¿è¡Œç¤ºä¾‹...';
            color: #888;
            font-style: italic;
        }

        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 0.9em;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 3px solid #667eea;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 3px;
            font-size: 0.8em;
        }

        .info-box strong {
            color: #667eea;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 600;
            margin-left: 5px;
        }

        .badge.new {
            background: #ff6b6b;
            color: white;
        }

        .badge.hot {
            background: #ffd93d;
            color: #333;
        }

        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 0;
        }

        .chart-box {
            background: white;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-box h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 0.95em;
            text-align: center;
        }
        
        /* PVEå›¾è¡¨æ·±è‰²ä¸»é¢˜ */
        #pveChartsContainer .chart-box {
            background: linear-gradient(135deg, #2c2f45 0%, #3a3f5c 100%);
        }
        
        #pveChartsContainer .chart-wrapper {
            background: #2c2f45;
            border-radius: 6px;
            padding: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 200px;
        }

        .chart-wrapper canvas {
            max-height: 100%;
        }

        /* å›¾è¡¨å ä½ç¬¦æ ·å¼ */
        .chart-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 0.9em;
            font-style: italic;
            background: rgba(255, 255, 255, 0.02);
            border: 1px dashed rgba(150, 150, 150, 0.3);
            border-radius: 4px;
            pointer-events: none;
        }

        .chart-placeholder.hidden {
            display: none;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .chart-wrapper.tall {
            height: 250px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .output-container {
                max-height: none;
                height: auto;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }

            .button-grid {
                grid-template-columns: 1fr;
            }

            #output {
                font-size: 11px;
                max-height: 250px;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .chart-wrapper {
                height: 180px;
            }

            .chart-wrapper.tall {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- å¤´éƒ¨ -->
            <div class="header">
                <h1>âš”ï¸ SoonFx Engine æˆ˜æ–—ç³»ç»Ÿæ¼”ç¤º</h1>
                <p>åŸºäº SoonFx Engine çš„æˆ˜æ–—æ•°æ®å¯è§†åŒ–ç³»ç»Ÿ - æ”¯æŒPVEæˆ˜æ–—æ•°æ®åˆ†æä¸å›¾è¡¨å±•ç¤º</p>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="controls">
                <!-- <h2>ğŸ® æˆ˜æ–—æ¼”ç¤º</h2>
                
                <div class="info-box">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong> ç‚¹å‡»è¿è¡ŒæŒ‰é’®å¼€å§‹PVEæˆ˜æ–—æ¼”ç¤ºã€‚æˆ˜æ–—æ•°æ®å°†ä»¥ä¸‰çº¿å›¾çš„å½¢å¼å±•ç¤ºç”Ÿå‘½å€¼ã€ä¼¤å®³å’Œå›åˆæ—¶é—´å˜åŒ–ï¼Œè¯¦ç»†æ—¥å¿—è®°å½•åœ¨å³ä¾§ã€‚
                </div> -->

            <div class="button-grid">
                <button class="btn" onclick="showPVECharts()" title="æ˜¾ç¤ºPVEä¸‰çº¿å›¾">
                    ğŸ“Š <span class="badge new">è¿è¡Œ</span>
                </button>
                <button class="btn" onclick="clearOutput()">
                    ğŸ—‘ï¸ æ¸…ç©º
                </button> 
            </div>
 
        </div>

        <!-- å›¾è¡¨å±•ç¤ºåŒºåŸŸ -->
        <div class="charts-container" id="chartsContainer" style="display: grid;">
            <!-- PVEä¸‰çº¿å›¾åŒºåŸŸ -->
            <div id="pveChartsContainer" style="display: block;">
                <!-- PVEç”Ÿå‘½çº¿ -->
                <div class="chart-box full-width" style="margin-bottom: 10px;">
                    <h3 style="color: white; background: linear-gradient(135deg, #3a3f5c 0%, #2c2f45 100%); padding: 8px; margin: -12px -12px 10px -12px; border-radius: 6px 6px 0 0; font-size: 0.9em;">
                        PVEç”Ÿå‘½çº¿ 
                        <span id="currentLevelHp" style="font-size: 0.8em; color: #ffc800; margin-left: 10px; display: none;">â— å½“å‰ç­‰çº§: <span id="currentLevelNumHp">1</span></span>
                    </h3>
                    <div style="color: #888; font-size: 0.75em; margin-bottom: 5px;">ç”Ÿå‘½</div>
                    <div class="chart-wrapper" style="height: 176px; position: relative;">
                        <canvas id="pveHpChart"></canvas>
                        <div id="pveHpPlaceholder" class="chart-placeholder">ç­‰å¾…æ•°æ®åŠ è½½...</div>
                    </div>
                </div>

                <!-- PVEä¼¤å®³çº¿ -->
                <div class="chart-box full-width" style="margin-bottom: 10px;">
                    <h3 style="color: white; background: linear-gradient(135deg, #3a3f5c 0%, #2c2f45 100%); padding: 8px; margin: -12px -12px 10px -12px; border-radius: 6px 6px 0 0; font-size: 0.9em;">
                        PVEä¼¤å®³çº¿
                        <span id="currentLevelDmg" style="font-size: 0.8em; color: #ffc800; margin-left: 10px; display: none;">â— å½“å‰ç­‰çº§: <span id="currentLevelNumDmg">1</span></span>
                    </h3>
                    <div style="color: #888; font-size: 0.75em; margin-bottom: 5px;">æ”»å‡»</div>
                    <div class="chart-wrapper" style="height: 176px; position: relative;">
                        <canvas id="pveDamageChart"></canvas>
                        <div id="pveDamagePlaceholder" class="chart-placeholder">ç­‰å¾…æ•°æ®åŠ è½½...</div>
                    </div>
                </div>

                <!-- PVEæ—¶é—´çº¿ -->
                <div class="chart-box full-width" style="margin-bottom: 10px;">
                    <h3 style="color: white; background: linear-gradient(135deg, #3a3f5c 0%, #2c2f45 100%); padding: 8px; margin: -12px -12px 10px -12px; border-radius: 6px 6px 0 0; font-size: 0.9em;">
                        PVEæ—¶é—´çº¿
                        <span id="currentLevelTime" style="font-size: 0.8em; color: #ffc800; margin-left: 10px; display: none;">â— å½“å‰ç­‰çº§: <span id="currentLevelNumTime">1</span></span>
                    </h3>
                    <div style="color: #888; font-size: 0.75em; margin-bottom: 5px;">å›åˆ</div>
                    <div class="chart-wrapper" style="height: 176px; position: relative;">
                        <canvas id="pveTimeChart"></canvas>
                        <div id="pveTimePlaceholder" class="chart-placeholder">ç­‰å¾…æ•°æ®åŠ è½½...</div>
                    </div>
                </div>
            </div>

            <!-- å›åˆæ•°å¯¹æ¯”å›¾ï¼ˆå¤šåœºå¯¹æ¯”æ—¶å¸¸é©»ï¼‰ -->
            <div class="chart-box full-width" id="roundsChartBox" style="display: none;">
                <h3>â±ï¸ æˆ˜æ–—å›åˆæ•°å¯¹æ¯” <span style="font-size: 0.8em; color: #888;">(ç‚¹å‡»æŸ±çŠ¶å›¾æŸ¥çœ‹è¯¥åœºæˆ˜æ–—è¯¦æƒ…)</span></h3>
                <div class="chart-wrapper">
                    <canvas id="roundsChart"></canvas>
                </div>
            </div>

            </div>
        </div>

        <!-- å³ä¾§è¾“å‡ºåŒºåŸŸ -->
        <div class="output-container">
            <h2>ğŸ“‹ æˆ˜æ–—è¯¦æƒ…</h2>
            
            <!-- çŠ¶æ€ä¿¡æ¯ï¼ˆç½®é¡¶æ˜¾ç¤ºï¼‰ -->
            <div id="status"></div>
            
            <!-- å¤šåœºæˆ˜æ–—è¯¦æƒ…åŒº -->
            <div id="battleDetailContainer" style="display: block; margin-bottom: 20px;">
                <div class="chart-box" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border: 2px solid #667eea; margin-bottom: 15px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 id="battleDetailTitle" style="margin: 0; font-size: 1em;">ğŸ“Š æˆ˜æ–—è¯¦æƒ…</h3>
                        <!-- <button class="btn" onclick="closeBattleDetail()" style="margin: 0; padding: 6px 12px; font-size: 0.85em; display: none;" id="closeBattleDetailBtn">å…³é—­</button> -->
                    </div>
                </div>

                <!-- è¯¦æƒ…è¡€é‡å›¾ -->
                <div class="chart-box" style="margin-bottom: 15px;">
                    <h3 style="font-size: 0.95em;">âš”ï¸ è¡€é‡å˜åŒ–æ›²çº¿</h3>
                    <div class="chart-wrapper" style="height: 200px; position: relative;">
                        <canvas id="detailHpChart"></canvas>
                        <div id="detailHpPlaceholder" class="chart-placeholder">ç‚¹å‡»å›¾è¡¨æŸ¥çœ‹æˆ˜æ–—è¯¦æƒ…</div>
                    </div>
                </div>
                
                <!-- è¯¦æƒ…ä¼¤å®³å›¾ -->
                <div class="chart-box" style="margin-bottom: 15px;">
                    <h3 style="font-size: 0.95em;">ğŸ’¥ ä¼¤å®³ç»Ÿè®¡å¯¹æ¯”</h3>
                    <div class="chart-wrapper" style="height: 200px; position: relative;">
                        <canvas id="detailDamageChart"></canvas>
                        <div id="detailDamagePlaceholder" class="chart-placeholder">ç‚¹å‡»å›¾è¡¨æŸ¥çœ‹æˆ˜æ–—è¯¦æƒ…</div>
                    </div>
                </div>
            </div>

            <div id="output"></div>
        </div>
    </div>

    <!-- åŠ è½½ SoonFx Engine å’Œç›¸å…³è„šæœ¬ -->
    <script type="module">
        // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µå¯¼å…¥ç¼–è¯‘åçš„ JS æ–‡ä»¶
        // import { runAllExamples, exampleSingleBattle, ... } from './dist/battle-demo.js';
        
        // ç­‰å¾… Chart.js åŠ è½½å®Œæˆ
        await new Promise((resolve) => {
            if (typeof Chart !== 'undefined') {
                resolve();
            } else {
                window.addEventListener('load', resolve);
            }
        });
        
        // å…¨å±€å‡½æ•°å®šä¹‰
        window.outputElement = document.getElementById('output');
        window.statusElement = document.getElementById('status');
        window.chartInstances = {}; // å­˜å‚¨å›¾è¡¨å®ä¾‹
        window.multipleBattlesData = null; // å­˜å‚¨å¤šåœºæˆ˜æ–—çš„å®Œæ•´æ•°æ®
        window.selectedBattleIndex = -1; // è®°å½•å½“å‰é€‰ä¸­çš„æˆ˜æ–—ç´¢å¼•
        window.pveBattleData = null; // å­˜å‚¨PVEæˆ˜æ–—çš„å®Œæ•´æ•°æ®ï¼ˆåŒ…å«æ¯ä¸ªç­‰çº§çš„è¯¦ç»†æˆ˜æ–—æ•°æ®ï¼‰
        window.currentPVELevel = undefined; // å½“å‰é€‰ä¸­çš„PVEç­‰çº§ï¼ˆç”¨äºé«˜äº®æ˜¾ç¤ºï¼‰
        window.Chart = Chart; // åœ¨ window ä¸Šä¿å­˜ Chart å¼•ç”¨ä¾›å…¨å±€ä½¿ç”¨

        // é‡å†™ console.log ä»¥åŒæ—¶è¾“å‡ºåˆ°é¡µé¢
        const originalLog = console.log;
        let scrollScheduled = false; // æ ‡è®°æ˜¯å¦å·²å®‰æ’æ»šåŠ¨
        
        console.log = function(...args) {
            // originalLog.apply(console, args);
            const message = args.toString();
                        
            // args.map(arg => 
            //     typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            // ).join(' ');
            
            if (window.outputElement) {
                window.outputElement.textContent += message + '\n';
                
                // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
                // å¤šæ¬¡ console.log è°ƒç”¨åªä¼šåœ¨ä¸‹ä¸€å¸§æ‰§è¡Œä¸€æ¬¡æ»šåŠ¨
                if (!scrollScheduled) {
                    scrollScheduled = true;
                    requestAnimationFrame(() => {
                        if (window.outputElement) {
                            window.outputElement.scrollTop = window.outputElement.scrollHeight;
                        }
                        scrollScheduled = false;
                    });
                }
            }
        };

        // æ¸…ç©ºæ‰€æœ‰å›¾è¡¨
        window.clearCharts = function() {
            Object.values(window.chartInstances).forEach(chart => {
                if (chart) chart.destroy();
            });
            window.chartInstances = {};
            document.getElementById('chartsContainer').style.display = 'none';
        };

        // æ˜¾ç¤ºå›¾è¡¨å®¹å™¨
        window.showCharts = function() {
            document.getElementById('chartsContainer').style.display = 'grid';
        };


        // åˆ›å»ºå›åˆæ•°å¯¹æ¯”å›¾ï¼ˆå¸¦ç‚¹å‡»äº‹ä»¶å’Œé«˜äº®æ•ˆæœï¼‰
        window.createRoundsChart = function(results) {
            const ctx = document.getElementById('roundsChart');
            if (!ctx) return;

            if (window.chartInstances.roundsChart) {
                window.chartInstances.roundsChart.destroy();
            }

            // ä¿å­˜å®Œæ•´æ•°æ®ä¾›ç‚¹å‡»ä½¿ç”¨
            window.multipleBattlesData = results;

            const labels = results.map(r => r.åœºæ™¯ || r.æ•Œäºº || `æˆ˜æ–—${r.æˆ˜æ–—åºå·}`);
            const rounds = results.map(r => r.å›åˆæ•°);

            window.chartInstances.roundsChart = new window.Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æˆ˜æ–—å›åˆæ•°',
                        data: rounds,
                        backgroundColor: rounds.map((_, i) => 
                            i === window.selectedBattleIndex 
                                ? 'rgba(255, 99, 132, 0.8)' 
                                : 'rgba(102, 126, 234, 0.8)'
                        ),
                        borderColor: rounds.map((_, i) => 
                            i === window.selectedBattleIndex 
                                ? 'rgb(255, 99, 132)' 
                                : 'rgb(102, 126, 234)'
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            titleFont: {
                                size: 11
                            },
                            bodyFont: {
                                size: 10
                            },
                            callbacks: {
                                afterLabel: function(context) {
                                    return 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å›åˆæ•°',
                                font: {
                                    size: 11
                                }
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            window.selectedBattleIndex = index;
                            // æ›´æ–°å›¾è¡¨é¢œè‰²ä»¥é«˜äº®é€‰ä¸­é¡¹
                            window.createRoundsChart(results);
                            // æ˜¾ç¤ºè¯¦æƒ…
                            window.showBattleDetail(index);
                        }
                    }
                }
            });
        };


        // è®¾ç½®çŠ¶æ€
        window.setStatus = function(type, message) {
            if (window.statusElement) {
                window.statusElement.className = `status ${type}`;
                window.statusElement.textContent = message;
            }
        };

        // æ¸…ç©ºè¾“å‡º
        window.clearOutput = function() {
            if (window.outputElement) {
                window.outputElement.textContent = '';
            }
            if (window.statusElement) {
                window.statusElement.className = '';
                window.statusElement.textContent = '';
            }
            window.clearCharts();
        };

        // æ‰“å¼€æ§åˆ¶å°æç¤º
        window.openConsole = function() {
            alert('è¯·æŒ‰ F12 é”®æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹è¯¦ç»†çš„æˆ˜æ–—æ•°æ®å’Œæ—¥å¿—ã€‚\n\nåœ¨æ§åˆ¶å°ä¸­ï¼Œä½ è¿˜å¯ä»¥ç›´æ¥è°ƒç”¨ï¼š\n- battleDemo.runAllExamples()\n- battleDemo.exampleSingleBattle()\n- battleDemo.exampleMultipleBattles()\n- battleDemo.exampleConsecutiveBattles()\n- battleDemo.exampleWinRateAnalysis()');
        };

        // æ˜¾ç¤ºå•åœºæˆ˜æ–—è¯¦æƒ…ï¼ˆåœ¨å›åˆæ•°å›¾è¡¨ä¸‹æ–¹å±•ç¤ºï¼‰
        window.showBattleDetail = function(index) {
            if (!window.multipleBattlesData || !window.multipleBattlesData[index]) {
                console.error('æˆ˜æ–—æ•°æ®ä¸å­˜åœ¨');
                return;
            }

            const battle = window.multipleBattlesData[index];
            
            // è°ƒè¯•ï¼šè¾“å‡ºæˆ˜æ–—æ•°æ®
            console.log('æˆ˜æ–—ç´¢å¼•:', index);
            console.log('æˆ˜æ–—å¯¹è±¡:', battle);
            console.log('battleData:', battle.battleData);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æˆ˜æ–—æ•°æ®
            if (!battle.battleData || battle.battleData.length === 0) {
                console.error('è¯¥åœºæˆ˜æ–—æ²¡æœ‰è¯¦ç»†æ•°æ®ã€‚battle.battleData =', battle.battleData);
                alert('è¯¥åœºæˆ˜æ–—æ²¡æœ‰è¯¦ç»†æ•°æ®\n\nè°ƒè¯•ä¿¡æ¯:\n' + 
                      'æˆ˜æ–—åœºæ™¯: ' + battle.åœºæ™¯ + '\n' +
                      'battleDataç±»å‹: ' + typeof battle.battleData + '\n' +
                      'battleDataå€¼: ' + JSON.stringify(battle.battleData));
                return;
            }

            // ä¿æŒå›åˆæ•°å›¾è¡¨æ˜¾ç¤ºï¼Œåœ¨å…¶ä¸‹æ–¹æ˜¾ç¤ºè¯¦æƒ…
            document.getElementById('battleDetailContainer').style.display = 'block';

            // æ›´æ–°æ ‡é¢˜
            document.getElementById('battleDetailTitle').textContent = 
                `ğŸ“Š ${battle.åœºæ™¯} - ä¸»è§’Lv.${battle.ä¸»è§’ç­‰çº§} vs æ•ŒäººLv.${battle.æ•Œäººç­‰çº§} (å›åˆæ•°: ${battle.å›åˆæ•°})`;

            // åˆ›å»ºè¯¦æƒ…å›¾è¡¨
            window.createDetailHpChart(battle.battleData, battle.heroName, battle.enemyName);
            window.createDetailDamageChart(battle.battleData, battle.heroName, battle.enemyName);

            // å¹³æ»‘æ»šåŠ¨åˆ°è¯¦æƒ…åŒº
            document.getElementById('battleDetailContainer').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        };

        // å…³é—­æˆ˜æ–—è¯¦æƒ…
        window.closeBattleDetail = function() {
            // æ¸…é™¤å›¾è¡¨å¹¶æ˜¾ç¤ºå ä½ç¬¦
            if (window.chartInstances.detailHpChart) {
                window.chartInstances.detailHpChart.destroy();
                window.chartInstances.detailHpChart = null;
            }
            if (window.chartInstances.detailDamageChart) {
                window.chartInstances.detailDamageChart.destroy();
                window.chartInstances.detailDamageChart = null;
            }
            
            // æ˜¾ç¤ºå ä½ç¬¦
            const hpPlaceholder = document.getElementById('detailHpPlaceholder');
            const damagePlaceholder = document.getElementById('detailDamagePlaceholder');
            if (hpPlaceholder) hpPlaceholder.classList.remove('hidden');
            if (damagePlaceholder) damagePlaceholder.classList.remove('hidden');
            
            // éšè—å…³é—­æŒ‰é’®
            const closeBtn = document.getElementById('closeBattleDetailBtn');
            if (closeBtn) closeBtn.style.display = 'none';
            
            // é‡ç½®æ ‡é¢˜
            document.getElementById('battleDetailTitle').textContent = 'ğŸ“Š æˆ˜æ–—è¯¦æƒ…';
            
            // æ»šåŠ¨å›é¡¶éƒ¨
            document.getElementById('battleDetailContainer').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        };

        // æµ‹è¯•å‡½æ•°ï¼šç›´æ¥åœ¨æ§åˆ¶å°è°ƒç”¨æ¥æ£€æŸ¥æ•°æ®
        window.testPVEData = function() {
            console.log('===== PVEæ•°æ®æµ‹è¯• =====');
            console.log('pveBattleData å­˜åœ¨?', !!window.pveBattleData);
            console.log('pveBattleData é•¿åº¦:', window.pveBattleData?.length);
            
            if (window.pveBattleData && window.pveBattleData.length > 0) {
                const testIndex = 0;
                const testData = window.pveBattleData[testIndex];
                console.log(`æµ‹è¯•æ•°æ®[${testIndex}]:`, testData);
                console.log('  - level:', testData.level);
                console.log('  - rounds:', testData.rounds);
                console.log('  - hp:', testData.hp);
                console.log('  - damage:', testData.damage);
                console.log('  - battleDataå­˜åœ¨?', !!testData.battleData);
                console.log('  - battleDataç±»å‹:', typeof testData.battleData);
                console.log('  - battleDataé•¿åº¦:', testData.battleData?.length);
                console.log('  - battleDataå†…å®¹:', testData.battleData);
            }
        };

        // æ˜¾ç¤ºPVEæˆ˜æ–—è¯¦æƒ…ï¼ˆç‚¹å‡»PVEä¸‰çº¿å›¾çš„æ•°æ®ç‚¹æ—¶ï¼‰
        window.showPVEBattleDetail = function(index) {
            console.log('===== è°ƒè¯•ï¼šshowPVEBattleDetail è¢«è°ƒç”¨ =====');
            console.log('ç´¢å¼•:', index);
            console.log('window.pveBattleData å­˜åœ¨?', !!window.pveBattleData);
            console.log('window.pveBattleData é•¿åº¦:', window.pveBattleData?.length);
            
            if (!window.pveBattleData || !window.pveBattleData[index]) {
                console.error('PVEæˆ˜æ–—æ•°æ®ä¸å­˜åœ¨ï¼Œç´¢å¼•:', index);
                alert('PVEæˆ˜æ–—æ•°æ®ä¸å­˜åœ¨\n\nç´¢å¼•: ' + index + '\npveBattleDataæ˜¯å¦å­˜åœ¨: ' + !!window.pveBattleData);
                return;
            }

            const battleInfo = window.pveBattleData[index];
            
            // è°ƒè¯•ï¼šè¾“å‡ºæˆ˜æ–—æ•°æ®
            console.log('PVEæˆ˜æ–—å¯¹è±¡:', battleInfo);
            console.log('battleInfo çš„æ‰€æœ‰é”®:', Object.keys(battleInfo));
            console.log('battleData å­˜åœ¨?', 'battleData' in battleInfo);
            // console.log('battleData å€¼:', battleInfo.battleData);
            console.log('battleData ç±»å‹:', typeof battleInfo.battleData);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æˆ˜æ–—æ•°æ®
            if (!battleInfo.battleData || battleInfo.battleData.length === 0) {
                console.error('è¯¥ç­‰çº§æ²¡æœ‰è¯¦ç»†æˆ˜æ–—æ•°æ®ã€‚battleInfo.battleData =', battleInfo.battleData);
                
                // æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
                const debugInfo = 'è°ƒè¯•ä¿¡æ¯:\n' + 
                      'ç­‰çº§: ' + battleInfo.level + '\n' +
                      'rounds: ' + battleInfo.rounds + '\n' +
                      'hp: ' + battleInfo.hp + '\n' +
                      'damage: ' + battleInfo.damage + '\n' +
                      'battleDataå­˜åœ¨?: ' + ('battleData' in battleInfo) + '\n' +
                      'battleDataç±»å‹: ' + typeof battleInfo.battleData + '\n' +
                      'battleDataå€¼: ' + JSON.stringify(battleInfo.battleData) + '\n' +
                      'æ‰€æœ‰å­—æ®µ: ' + Object.keys(battleInfo).join(', ');
                
                alert('è¯¥ç­‰çº§æ²¡æœ‰è¯¦ç»†æˆ˜æ–—æ•°æ®\n\n' + debugInfo);
                return;
            }

            // æ›´æ–°å½“å‰ç­‰çº§ï¼ˆç”¨äºé«˜äº®æ˜¾ç¤ºï¼‰
            window.currentPVELevel = battleInfo.level;
            
            // æ›´æ–°å›¾è¡¨æ ‡é¢˜ä¸­çš„å½“å‰ç­‰çº§æ˜¾ç¤º
            const currentLevelHp = document.getElementById('currentLevelHp');
            const currentLevelDmg = document.getElementById('currentLevelDmg');
            const currentLevelTime = document.getElementById('currentLevelTime');
            const currentLevelNumHp = document.getElementById('currentLevelNumHp');
            const currentLevelNumDmg = document.getElementById('currentLevelNumDmg');
            const currentLevelNumTime = document.getElementById('currentLevelNumTime');
            
            if (currentLevelHp) currentLevelHp.style.display = 'inline';
            if (currentLevelDmg) currentLevelDmg.style.display = 'inline';
            if (currentLevelTime) currentLevelTime.style.display = 'inline';
            if (currentLevelNumHp) currentLevelNumHp.textContent = battleInfo.level;
            if (currentLevelNumDmg) currentLevelNumDmg.textContent = battleInfo.level;
            if (currentLevelNumTime) currentLevelNumTime.textContent = battleInfo.level;
            
            // åˆ·æ–°æ‰€æœ‰PVEå›¾è¡¨ä»¥æ›´æ–°é«˜äº®
            if (window.pveBattleData) {
                window.updatePVECharts(window.pveBattleData);
            }

            // æ˜¾ç¤ºè¯¦æƒ…å®¹å™¨
            document.getElementById('battleDetailContainer').style.display = 'block';

            // æ›´æ–°æ ‡é¢˜
            document.getElementById('battleDetailTitle').textContent = 
                `ğŸ“Š ç­‰çº§${battleInfo.level}æˆ˜æ–—è¯¦æƒ… - å›åˆæ•°: ${battleInfo.rounds} | ç”Ÿå‘½: ${Math.round(battleInfo.hp)} | æ”»å‡»: ${Math.round(battleInfo.damage)}`;

            // åˆ›å»ºè¯¦æƒ…å›¾è¡¨
            window.createDetailHpChart(battleInfo.battleData, battleInfo.heroName || 'ä¸»è§’', battleInfo.enemyName || 'æ•Œäºº');
            window.createDetailDamageChart(battleInfo.battleData, battleInfo.heroName || 'ä¸»è§’', battleInfo.enemyName || 'æ•Œäºº');

            // å¹³æ»‘æ»šåŠ¨åˆ°è¯¦æƒ…åŒº
            document.getElementById('battleDetailContainer').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        };

        // åˆ›å»ºè¯¦æƒ…è¡€é‡å˜åŒ–å›¾
        window.createDetailHpChart = function(battleData, heroName, enemyName) {
            const ctx = document.getElementById('detailHpChart');
            if (!ctx) return;

            if (window.chartInstances.detailHpChart) {
                window.chartInstances.detailHpChart.destroy();
            }

            // éšè—å ä½ç¬¦ï¼Œæ˜¾ç¤ºå…³é—­æŒ‰é’®
            const placeholder = document.getElementById('detailHpPlaceholder');
            if (placeholder) placeholder.classList.add('hidden');
            const closeBtn = document.getElementById('closeBattleDetailBtn');
            if (closeBtn) closeBtn.style.display = 'inline-block';

            const rounds = battleData.map(d => `ç¬¬${d.round}å›åˆ`);
            const heroHp = battleData.map(d => d.heroHp);
            const enemyHp = battleData.map(d => d.enemyHp);

            window.chartInstances.detailHpChart = new window.Chart(ctx, {
                type: 'line',
                data: {
                    labels: rounds,
                    datasets: [{
                        label: heroName + ' ç”Ÿå‘½å€¼',
                        data: heroHp,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: enemyName + ' ç”Ÿå‘½å€¼',
                        data: enemyHp,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            titleFont: {
                                size: 11
                            },
                            bodyFont: {
                                size: 10
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ç”Ÿå‘½å€¼ (HP)',
                                font: {
                                    size: 11
                                }
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    if (value >= 1000) {
                                        return (value / 1000).toFixed(1) + 'k';
                                    }
                                    return value;
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        };

        // åˆ›å»ºè¯¦æƒ…ä¼¤å®³ç»Ÿè®¡å›¾
        window.createDetailDamageChart = function(battleData, heroName, enemyName) {
            const ctx = document.getElementById('detailDamageChart');
            if (!ctx) return;

            if (window.chartInstances.detailDamageChart) {
                window.chartInstances.detailDamageChart.destroy();
            }

            // éšè—å ä½ç¬¦
            const placeholder = document.getElementById('detailDamagePlaceholder');
            if (placeholder) placeholder.classList.add('hidden');

            const totalHeroDamage = battleData.reduce((sum, d) => sum + (d.heroDamageDealt || 0), 0);
            const totalEnemyDamage = battleData.reduce((sum, d) => sum + (d.enemyDamageDealt || 0), 0);
            const avgHeroDamage = (totalHeroDamage / battleData.length).toFixed(1);
            const avgEnemyDamage = (totalEnemyDamage / battleData.length).toFixed(1);

            window.chartInstances.detailDamageChart = new window.Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['æ€»ä¼¤å®³', 'å¹³å‡ä¼¤å®³/å›åˆ'],
                    datasets: [{
                        label: heroName,
                        data: [totalHeroDamage, avgHeroDamage],
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgb(75, 192, 192)',
                        borderWidth: 2
                    }, {
                        label: enemyName,
                        data: [totalEnemyDamage, avgEnemyDamage],
                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            titleFont: {
                                size: 11
                            },
                            bodyFont: {
                                size: 10
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ä¼¤å®³å€¼',
                                font: {
                                    size: 11
                                }
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    if (value >= 1000) {
                                        return (value / 1000).toFixed(1) + 'k';
                                    }
                                    return value;
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        };

        // PVEä¸‰çº¿å›¾åŠŸèƒ½å‡½æ•°
        // æ˜¾ç¤ºPVEä¸‰çº¿å›¾
        window.showPVECharts = async function() {
            window.clearOutput();
            window.setStatus('loading', 'ğŸ”„ æ­£åœ¨ç”ŸæˆPVEä¸‰çº¿å›¾æ•°æ®ï¼Œè¿›è¡Œ50åœºå®é™…æˆ˜æ–—æ¨¡æ‹Ÿ...');
            
            try {
                // é‡ç½®å½“å‰ç­‰çº§
                window.currentPVELevel = undefined;
                
                // éšè—å½“å‰ç­‰çº§æŒ‡ç¤ºå™¨
                const currentLevelHp = document.getElementById('currentLevelHp');
                const currentLevelDmg = document.getElementById('currentLevelDmg');
                const currentLevelTime = document.getElementById('currentLevelTime');
                if (currentLevelHp) currentLevelHp.style.display = 'none';
                if (currentLevelDmg) currentLevelDmg.style.display = 'none';
                if (currentLevelTime) currentLevelTime.style.display = 'none';
                
                // å›¾è¡¨å®¹å™¨å·²é»˜è®¤æ˜¾ç¤ºï¼Œä¸éœ€è¦å†æ¬¡æ˜¾ç¤º
                // éšè—å…¶ä»–å›¾è¡¨ï¼Œåªæ˜¾ç¤ºPVEä¸‰çº¿å›¾
                document.getElementById('roundsChartBox').style.display = 'none';
                // document.getElementById('battleDetailContainer').style.display = 'none';
                document.getElementById('pveChartsContainer').style.display = 'block';
                document.getElementById('chartsContainer').style.display = 'grid';
                
                // ä¸éœ€è¦åˆå§‹åŒ–ç©ºå›¾è¡¨ï¼Œä¿æŒå ä½ç¬¦æ˜¾ç¤ºå³å¯
                
                // ç”Ÿæˆå®é™…çš„50ä¸ªç­‰çº§çš„PVEæˆ˜æ–—æ•°æ®ï¼Œå¸¦æ¸è¿›å¼æ›´æ–°
                const pveData = await window.generatePVEData((data, level, total) => {
                    // æ¯å®Œæˆä¸€ä¸ªç­‰çº§çš„æˆ˜æ–—ï¼Œæ›´æ–°å›¾è¡¨
                    window.updatePVECharts(data);
                    // åŒæ—¶ä¿å­˜æ•°æ®ï¼ˆæ¸è¿›å¼ä¿å­˜ï¼‰
                    window.pveBattleData = data;
                    // æ›´æ–°çŠ¶æ€ä¿¡æ¯
                    window.setStatus('loading', `ğŸ”„ æ­£åœ¨ç”ŸæˆPVEæ•°æ®... ${level}/${total} (${Math.round(level/total*100)}%)`);
                    
                    // å½“ç¬¬ä¸€ä¸ªç­‰çº§çš„æ•°æ®è¿”å›åï¼Œè‡ªåŠ¨é€‰ä¸­ç¬¬1çº§
                    if (level === 1 && data.length > 0) {
                        // è®¾ç½®å½“å‰ç­‰çº§ä¸º1
                        window.currentPVELevel = 1;
                        
                        // æ˜¾ç¤ºç­‰çº§æŒ‡ç¤ºå™¨
                        const currentLevelHp = document.getElementById('currentLevelHp');
                        const currentLevelDmg = document.getElementById('currentLevelDmg');
                        const currentLevelTime = document.getElementById('currentLevelTime');
                        const currentLevelNumHp = document.getElementById('currentLevelNumHp');
                        const currentLevelNumDmg = document.getElementById('currentLevelNumDmg');
                        const currentLevelNumTime = document.getElementById('currentLevelNumTime');
                        
                        if (currentLevelHp) currentLevelHp.style.display = 'inline';
                        if (currentLevelDmg) currentLevelDmg.style.display = 'inline';
                        if (currentLevelTime) currentLevelTime.style.display = 'inline';
                        if (currentLevelNumHp) currentLevelNumHp.textContent = '1';
                        if (currentLevelNumDmg) currentLevelNumDmg.textContent = '1';
                        if (currentLevelNumTime) currentLevelNumTime.textContent = '1';
                        
                        // æ˜¾ç¤ºç¬¬1çº§çš„æˆ˜æ–—è¯¦æƒ…
                        const battleInfo = data[0];
                        if (battleInfo && battleInfo.battleData && battleInfo.battleData.length > 0) {
                            // æ˜¾ç¤ºè¯¦æƒ…å®¹å™¨
                            document.getElementById('battleDetailContainer').style.display = 'block';
                            
                            // æ›´æ–°æ ‡é¢˜
                            document.getElementById('battleDetailTitle').textContent = 
                                `ğŸ“Š ç­‰çº§${battleInfo.level}æˆ˜æ–—è¯¦æƒ… - å›åˆæ•°: ${battleInfo.rounds} | ç”Ÿå‘½: ${Math.round(battleInfo.hp)} | æ”»å‡»: ${Math.round(battleInfo.damage)}`;
                            
                            // åˆ›å»ºè¯¦æƒ…å›¾è¡¨
                            window.createDetailHpChart(battleInfo.battleData, battleInfo.heroName || 'ä¸»è§’', battleInfo.enemyName || 'æ•Œäºº');
                            window.createDetailDamageChart(battleInfo.battleData, battleInfo.heroName || 'ä¸»è§’', battleInfo.enemyName || 'æ•Œäºº');
                        }
                    }
                });
                
                // ä¿å­˜å®Œæ•´çš„PVEæˆ˜æ–—æ•°æ®
                window.pveBattleData = pveData;
                
                // è°ƒè¯•æ—¥å¿—
                console.log('PVEä¸‰çº¿å›¾å·²ç”Ÿæˆï¼Œæ•°æ®ç‚¹æ•°:', pveData.length);
                // console.log('pveDataå®Œæ•´æ•°æ®ï¼ˆå‰3ä¸ªï¼‰:', pveData.slice(0, 3));
                console.log('ç¬¬ä¸€ä¸ªæ•°æ®ç‚¹:', pveData[0]);
                console.log('ç¬¬ä¸€ä¸ªæ•°æ®ç‚¹çš„battleDataå­˜åœ¨?', !!pveData[0]?.battleData);
                console.log('ç¬¬ä¸€ä¸ªæ•°æ®ç‚¹çš„battleDataé•¿åº¦:', pveData[0]?.battleData?.length);
                console.log('æœ€åä¸€ä¸ªæ•°æ®ç‚¹çš„battleDataå­˜åœ¨?', !!pveData[pveData.length-1]?.battleData);
                console.log('æœ€åä¸€ä¸ªæ•°æ®ç‚¹çš„battleDataé•¿åº¦:', pveData[pveData.length-1]?.battleData?.length);
                
                window.setStatus('success', 'âœ… PVEä¸‰çº¿å›¾ç”Ÿæˆå®Œæˆï¼åŸºäº50åœºå®é™…æˆ˜æ–—æ•°æ®ã€‚ç‚¹å‡»å›¾è¡¨ä¸Šçš„ç‚¹æŸ¥çœ‹è¯¥ç­‰çº§çš„æˆ˜æ–—è¯¦æƒ…ã€‚');
            } catch (error) {
                console.error('ç”ŸæˆPVEä¸‰çº¿å›¾æ—¶å‡ºé”™:', error);
                window.setStatus('error', 'âŒ ç”Ÿæˆå¤±è´¥: ' + error.message);
            }
        };

        // ç”ŸæˆPVEæµ‹è¯•æ•°æ®ï¼ˆä½¿ç”¨å®é™…æˆ˜æ–—æ•°å€¼ï¼‰
        // è¯¥å‡½æ•°ç°åœ¨ç›´æ¥è°ƒç”¨ä» battle-demo.ts å¯¼å‡ºçš„å‡½æ•°
        window.generatePVEData = async function(onProgress, maxLevel = 50) {
            // æ£€æŸ¥battleDemoæ¨¡å—æ˜¯å¦å­˜åœ¨
            if (typeof window.battleDemo === 'undefined') {
                throw new Error('æˆ˜æ–—æ¼”ç¤ºæ¨¡å—æœªåŠ è½½');
            }
            
            // è°ƒç”¨ä» battle-demo.ts å¯¼å‡ºçš„ generatePVEData å‡½æ•°ï¼Œä¼ é€’å›è°ƒå‡½æ•°
            return await window.battleDemo.generatePVEData(onProgress, maxLevel);
        };

        // æ›´æ–°æ‰€æœ‰PVEå›¾è¡¨ï¼ˆæ¸è¿›å¼æ›´æ–°ï¼‰
        window.updatePVECharts = function(pveData) {
            if (!pveData || pveData.length === 0) return;
            
            const levels = pveData.map(d => d.level);
            const hpValues = pveData.map(d => d.hp);
            const damageValues = pveData.map(d => d.damage);
            const roundsValues = pveData.map(d => d.rounds);
            
            // è·å–å½“å‰é€‰ä¸­çš„ç­‰çº§ç´¢å¼•ï¼ˆå¦‚æœæœ‰ï¼‰
            const currentLevelIndex = window.currentPVELevel !== undefined ? window.currentPVELevel - 1 : -1;
            
            // æ›´æ–°ç”Ÿå‘½å›¾è¡¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
            if (window.chartInstances.pveHpChart) {
                const chart = window.chartInstances.pveHpChart;
                chart.data.labels = levels;
                chart.data.datasets[0].data = hpValues;
                
                // æ›´æ–°ç‚¹çš„æ ·å¼ä»¥çªå‡ºæ˜¾ç¤ºå½“å‰ç­‰çº§
                chart.data.datasets[0].pointRadius = levels.map((_, idx) => idx === currentLevelIndex ? 8 : 4);
                chart.data.datasets[0].pointBackgroundColor = levels.map((_, idx) => 
                    idx === currentLevelIndex ? 'rgb(255, 200, 0)' : 'rgb(100, 200, 255)'
                );
                chart.data.datasets[0].pointBorderColor = levels.map((_, idx) => 
                    idx === currentLevelIndex ? 'rgb(255, 150, 0)' : 'rgb(100, 200, 255)'
                );
                chart.data.datasets[0].pointBorderWidth = levels.map((_, idx) => idx === currentLevelIndex ? 3 : 2);
                
                chart.update('none'); // ä½¿ç”¨ 'none' æ¨¡å¼å¿«é€Ÿæ›´æ–°ï¼Œä¸å¸¦åŠ¨ç”»
            } else {
                window.createPVEHpChart(pveData);
            }
            
            // æ›´æ–°ä¼¤å®³å›¾è¡¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
            if (window.chartInstances.pveDamageChart) {
                const chart = window.chartInstances.pveDamageChart;
                chart.data.labels = levels;
                chart.data.datasets[0].data = damageValues;
                
                // æ›´æ–°ç‚¹çš„æ ·å¼ä»¥çªå‡ºæ˜¾ç¤ºå½“å‰ç­‰çº§
                chart.data.datasets[0].pointRadius = levels.map((_, idx) => idx === currentLevelIndex ? 8 : 4);
                chart.data.datasets[0].pointBackgroundColor = levels.map((_, idx) => 
                    idx === currentLevelIndex ? 'rgb(255, 200, 0)' : 'rgb(255, 100, 100)'
                );
                chart.data.datasets[0].pointBorderColor = levels.map((_, idx) => 
                    idx === currentLevelIndex ? 'rgb(255, 150, 0)' : 'rgb(255, 100, 100)'
                );
                chart.data.datasets[0].pointBorderWidth = levels.map((_, idx) => idx === currentLevelIndex ? 3 : 2);
                
                chart.update('none');
            } else {
                window.createPVEDamageChart(pveData);
            }
            
            // æ›´æ–°å›åˆå›¾è¡¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
            if (window.chartInstances.pveTimeChart) {
                const chart = window.chartInstances.pveTimeChart;
                chart.data.labels = levels;
                chart.data.datasets[0].data = roundsValues;
                
                // æ›´æ–°ç‚¹çš„æ ·å¼ä»¥çªå‡ºæ˜¾ç¤ºå½“å‰ç­‰çº§
                chart.data.datasets[0].pointRadius = levels.map((_, idx) => idx === currentLevelIndex ? 8 : 4);
                chart.data.datasets[0].pointBackgroundColor = levels.map((_, idx) => 
                    idx === currentLevelIndex ? 'rgb(255, 200, 0)' : 'rgb(100, 150, 255)'
                );
                chart.data.datasets[0].pointBorderColor = levels.map((_, idx) => 
                    idx === currentLevelIndex ? 'rgb(255, 150, 0)' : 'rgb(100, 150, 255)'
                );
                chart.data.datasets[0].pointBorderWidth = levels.map((_, idx) => idx === currentLevelIndex ? 3 : 2);
                
                chart.update('none');
            } else {
                window.createPVETimeChart(pveData);
            }
        };

        // åˆ›å»ºPVEç”Ÿå‘½çº¿å›¾è¡¨
        window.createPVEHpChart = function(pveData) {
            const ctx = document.getElementById('pveHpChart');
            if (!ctx) return;

            if (window.chartInstances.pveHpChart) {
                window.chartInstances.pveHpChart.destroy();
            }

            // åªæœ‰å½“æœ‰æ•°æ®æ—¶æ‰éšè—å ä½ç¬¦
            const placeholder = document.getElementById('pveHpPlaceholder');
            if (pveData && pveData.length > 0) {
                if (placeholder) placeholder.classList.add('hidden');
            }

            const levels = pveData.map(d => d.level);
            const hpValues = pveData.map(d => d.hp);

            // è·å–å½“å‰é€‰ä¸­çš„ç­‰çº§ç´¢å¼•ï¼ˆå¦‚æœæœ‰ï¼‰
            const currentLevelIndex = window.currentPVELevel !== undefined ? window.currentPVELevel - 1 : -1;

            // ä¸ºæ¯ä¸ªç‚¹è®¾ç½®ä¸åŒçš„æ ·å¼ï¼Œçªå‡ºæ˜¾ç¤ºå½“å‰ç­‰çº§
            const pointRadii = levels.map((_, idx) => idx === currentLevelIndex ? 8 : 4);
            const pointBackgroundColors = levels.map((_, idx) => 
                idx === currentLevelIndex ? 'rgb(255, 200, 0)' : 'rgb(100, 200, 255)'
            );
            const pointBorderColors = levels.map((_, idx) => 
                idx === currentLevelIndex ? 'rgb(255, 150, 0)' : 'rgb(100, 200, 255)'
            );
            const pointBorderWidths = levels.map((_, idx) => idx === currentLevelIndex ? 3 : 2);

            window.chartInstances.pveHpChart = new window.Chart(ctx, {
                type: 'line',
                data: {
                    labels: levels,
                    datasets: [{
                        label: 'ç”Ÿå‘½',
                        data: hpValues,
                        borderColor: 'rgb(100, 200, 255)',
                        backgroundColor: 'rgba(100, 200, 255, 0.1)',
                        borderWidth: 2,
                        pointRadius: pointRadii,
                        pointBackgroundColor: pointBackgroundColors,
                        pointBorderColor: pointBorderColors,
                        pointBorderWidth: pointBorderWidths,
                        pointHoverRadius: 8,
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgb(100, 200, 255)',
                            borderWidth: 1,
                            callbacks: {
                                afterLabel: function(context) {
                                    return 'ç‚¹å‡»æŸ¥çœ‹è¯¥ç­‰çº§æˆ˜æ–—è¯¦æƒ…';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(150, 150, 150, 0.15)',
                                borderDash: [5, 5],
                                drawBorder: false
                            },
                            ticks: {
                                color: '#999',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    if (value >= 1000) {
                                        return (value / 1000).toFixed(1) + 'k';
                                    }
                                    return value;
                                }
                            },
                            border: {
                                display: false
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ç­‰çº§',
                                color: '#999',
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(150, 150, 150, 0.15)',
                                borderDash: [5, 5],
                                drawBorder: false
                            },
                            ticks: {
                                color: '#999',
                                font: {
                                    size: 11
                                }
                            },
                            border: {
                                display: false
                            }
                        }
                    },
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0 && window.pveBattleData) {
                            const index = activeElements[0].index;
                            window.showPVEBattleDetail(index);
                        }
                    }
                }
            });
        };

        // åˆ›å»ºPVEä¼¤å®³çº¿å›¾è¡¨
        window.createPVEDamageChart = function(pveData) {
            const ctx = document.getElementById('pveDamageChart');
            if (!ctx) return;

            if (window.chartInstances.pveDamageChart) {
                window.chartInstances.pveDamageChart.destroy();
            }

            // åªæœ‰å½“æœ‰æ•°æ®æ—¶æ‰éšè—å ä½ç¬¦
            const placeholder = document.getElementById('pveDamagePlaceholder');
            if (pveData && pveData.length > 0) {
                if (placeholder) placeholder.classList.add('hidden');
            }

            const levels = pveData.map(d => d.level);
            const damageValues = pveData.map(d => d.damage);

            // è·å–å½“å‰é€‰ä¸­çš„ç­‰çº§ç´¢å¼•ï¼ˆå¦‚æœæœ‰ï¼‰
            const currentLevelIndex = window.currentPVELevel !== undefined ? window.currentPVELevel - 1 : -1;

            // ä¸ºæ¯ä¸ªç‚¹è®¾ç½®ä¸åŒçš„æ ·å¼ï¼Œçªå‡ºæ˜¾ç¤ºå½“å‰ç­‰çº§
            const pointRadii = levels.map((_, idx) => idx === currentLevelIndex ? 8 : 4);
            const pointBackgroundColors = levels.map((_, idx) => 
                idx === currentLevelIndex ? 'rgb(255, 200, 0)' : 'rgb(255, 100, 100)'
            );
            const pointBorderColors = levels.map((_, idx) => 
                idx === currentLevelIndex ? 'rgb(255, 150, 0)' : 'rgb(255, 100, 100)'
            );
            const pointBorderWidths = levels.map((_, idx) => idx === currentLevelIndex ? 3 : 2);

            window.chartInstances.pveDamageChart = new window.Chart(ctx, {
                type: 'line',
                data: {
                    labels: levels,
                    datasets: [{
                        label: 'æ”»å‡»',
                        data: damageValues,
                        borderColor: 'rgb(255, 100, 100)',
                        backgroundColor: 'rgba(255, 100, 100, 0.1)',
                        borderWidth: 2,
                        pointRadius: pointRadii,
                        pointBackgroundColor: pointBackgroundColors,
                        pointBorderColor: pointBorderColors,
                        pointBorderWidth: pointBorderWidths,
                        pointHoverRadius: 8,
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgb(255, 100, 100)',
                            borderWidth: 1,
                            callbacks: {
                                afterLabel: function(context) {
                                    return 'ç‚¹å‡»æŸ¥çœ‹è¯¥ç­‰çº§æˆ˜æ–—è¯¦æƒ…';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(150, 150, 150, 0.15)',
                                borderDash: [5, 5],
                                drawBorder: false
                            },
                            ticks: {
                                color: '#999',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    if (value >= 1000) {
                                        return (value / 1000).toFixed(1) + 'k';
                                    }
                                    return value;
                                }
                            },
                            border: {
                                display: false
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ç­‰çº§',
                                color: '#999',
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(150, 150, 150, 0.15)',
                                borderDash: [5, 5],
                                drawBorder: false
                            },
                            ticks: {
                                color: '#999',
                                font: {
                                    size: 11
                                }
                            },
                            border: {
                                display: false
                            }
                        }
                    },
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0 && window.pveBattleData) {
                            const index = activeElements[0].index;
                            window.showPVEBattleDetail(index);
                        }
                    }
                }
            });
        };

        // åˆ›å»ºPVEæ—¶é—´çº¿å›¾è¡¨
        window.createPVETimeChart = function(pveData) {
            const ctx = document.getElementById('pveTimeChart');
            if (!ctx) return;

            if (window.chartInstances.pveTimeChart) {
                window.chartInstances.pveTimeChart.destroy();
            }

            // åªæœ‰å½“æœ‰æ•°æ®æ—¶æ‰éšè—å ä½ç¬¦
            const placeholder = document.getElementById('pveTimePlaceholder');
            if (pveData && pveData.length > 0) {
                if (placeholder) placeholder.classList.add('hidden');
            }

            const levels = pveData.map(d => d.level);
            const roundsValues = pveData.map(d => d.rounds);

            // è·å–å½“å‰é€‰ä¸­çš„ç­‰çº§ç´¢å¼•ï¼ˆå¦‚æœæœ‰ï¼‰
            const currentLevelIndex = window.currentPVELevel !== undefined ? window.currentPVELevel - 1 : -1;

            // ä¸ºæ¯ä¸ªç‚¹è®¾ç½®ä¸åŒçš„æ ·å¼ï¼Œçªå‡ºæ˜¾ç¤ºå½“å‰ç­‰çº§
            const pointRadii = levels.map((_, idx) => idx === currentLevelIndex ? 8 : 4);
            const pointBackgroundColors = levels.map((_, idx) => 
                idx === currentLevelIndex ? 'rgb(255, 200, 0)' : 'rgb(100, 150, 255)'
            );
            const pointBorderColors = levels.map((_, idx) => 
                idx === currentLevelIndex ? 'rgb(255, 150, 0)' : 'rgb(100, 150, 255)'
            );
            const pointBorderWidths = levels.map((_, idx) => idx === currentLevelIndex ? 3 : 2);

            window.chartInstances.pveTimeChart = new window.Chart(ctx, {
                type: 'line',
                data: {
                    labels: levels,
                    datasets: [{
                        label: 'å›åˆ',
                        data: roundsValues,
                        borderColor: 'rgb(100, 150, 255)',
                        backgroundColor: 'rgba(100, 150, 255, 0.1)',
                        borderWidth: 2,
                        pointRadius: pointRadii,
                        pointBackgroundColor: pointBackgroundColors,
                        pointBorderColor: pointBorderColors,
                        pointBorderWidth: pointBorderWidths,
                        pointHoverRadius: 8,
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgb(100, 150, 255)',
                            borderWidth: 1,
                            callbacks: {
                                afterLabel: function(context) {
                                    return 'ç‚¹å‡»æŸ¥çœ‹è¯¥ç­‰çº§æˆ˜æ–—è¯¦æƒ…';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(150, 150, 150, 0.15)',
                                borderDash: [5, 5],
                                drawBorder: false
                            },
                            ticks: {
                                color: '#999',
                                font: {
                                    size: 11
                                }
                            },
                            border: {
                                display: false
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ç­‰çº§',
                                color: '#999',
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(150, 150, 150, 0.15)',
                                borderDash: [5, 5],
                                drawBorder: false
                            },
                            ticks: {
                                color: '#999',
                                font: {
                                    size: 11
                                }
                            },
                            border: {
                                display: false
                            }
                        }
                    },
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0 && window.pveBattleData) {
                            const index = activeElements[0].index;
                            window.showPVEBattleDetail(index);
                        }
                    }
                }
            });
        };

        // ç¤ºä¾‹å‡½æ•°ï¼ˆéœ€è¦åœ¨å®é™…é¡¹ç›®ä¸­ä»ç¼–è¯‘åçš„æ¨¡å—å¯¼å…¥ï¼‰
        window.runAllExamples = async function() {
            window.clearOutput();
            window.setStatus('loading', 'ğŸ”„ æ­£åœ¨è¿è¡Œå¤šåœºæˆ˜æ–—å¯¹æ¯”ç¤ºä¾‹ï¼Œè¯·ç¨å€™...');
            
            try {
                console.log('å¼€å§‹è¿è¡Œå¤šåœºæˆ˜æ–—å¯¹æ¯”ç¤ºä¾‹...\n');
                
                // æ£€æŸ¥ battleDemo æ˜¯å¦å·²åŠ è½½
                if (typeof window.battleDemo !== 'undefined') {
                    await window.battleDemo.runAllExamples();
                    window.setStatus('success', 'âœ… å¤šåœºæˆ˜æ–—å¯¹æ¯”ç¤ºä¾‹è¿è¡Œå®Œæˆï¼');
                } else {
                    throw new Error('æˆ˜æ–—æ¼”ç¤ºæ¨¡å—æœªåŠ è½½ã€‚è¯·ç¡®ä¿å·²æ­£ç¡®æ„å»ºé¡¹ç›®ã€‚');
                }
            } catch (error) {
                console.error('è¿è¡Œç¤ºä¾‹æ—¶å‡ºé”™:', error);
                window.setStatus('error', 'âŒ è¿è¡Œå¤±è´¥: ' + error.message);
            }
        };

        window.runMultipleBattles = async function() {
            window.clearOutput();
            window.setStatus('loading', 'ğŸ”„ æ­£åœ¨è¿è¡Œå¤šåœºæˆ˜æ–—å¯¹æ¯”...');
            
            try {
                if (typeof window.battleDemo !== 'undefined') {
                    const results = await window.battleDemo.exampleMultipleBattles();
                    
                    // è°ƒè¯•ï¼šæŸ¥çœ‹è¿”å›çš„ç»“æœ
                    console.log('exampleMultipleBattles è¿”å›çš„ç»“æœ:', results);
                    console.log('ç»“æœæ•°é‡:', results.length);
                    results.forEach((r, i) => {
                        console.log(`æˆ˜æ–— ${i}:`, r);
                        console.log(`  battleDataå­˜åœ¨?`, !!r.battleData);
                        console.log(`  battleDataé•¿åº¦:`, r.battleData ? r.battleData.length : 'undefined');
                    });
                    
                    // æ˜¾ç¤ºå›¾è¡¨å®¹å™¨
                    window.showCharts();
                    
                    // åªæ˜¾ç¤ºå›åˆæ•°å¯¹æ¯”å›¾
                    document.getElementById('roundsChartBox').style.display = 'block';
                    document.getElementById('battleDetailContainer').style.display = 'none';
                    
                    // é‡ç½®é€‰ä¸­çŠ¶æ€
                    window.selectedBattleIndex = -1;
                    
                    // åˆ›å»ºå›åˆæ•°å¯¹æ¯”å›¾ï¼ˆå¸¦ç‚¹å‡»äº‹ä»¶ï¼‰
                    window.createRoundsChart(results);
                    window.setStatus('success', 'âœ… å¤šåœºæˆ˜æ–—å¯¹æ¯”å®Œæˆï¼ç‚¹å‡»æŸ±çŠ¶å›¾æŸ¥çœ‹è¯¥åœºæˆ˜æ–—çš„è¯¦ç»†æ•°æ®ã€‚');
                } else {
                    throw new Error('æˆ˜æ–—æ¼”ç¤ºæ¨¡å—æœªåŠ è½½');
                }
            } catch (error) {
                console.error('è¿è¡Œç¤ºä¾‹æ—¶å‡ºé”™:', error);
                window.setStatus('error', 'âŒ è¿è¡Œå¤±è´¥: ' + error.message);
            }
        };


        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('å¤šåœºæˆ˜æ–—å¯¹æ¯”æ¼”ç¤ºé¡µé¢å·²åŠ è½½');
            console.log('è¯·ç‚¹å‡»æŒ‰é’®è¿è¡Œå¤šåœºæˆ˜æ–—å¯¹æ¯”ç¤ºä¾‹ï¼Œæˆ–åœ¨æ§åˆ¶å°ä¸­ç›´æ¥è°ƒç”¨å‡½æ•°ã€‚');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ battleDemo
            if (typeof window.battleDemo === 'undefined') {
                window.setStatus('error', 'âš ï¸ æˆ˜æ–—æ¼”ç¤ºæ¨¡å—æœªåŠ è½½ã€‚è¯·ç¡®ä¿å·²æ­£ç¡®æ„å»ºé¡¹ç›®å¹¶å¼•å…¥ç›¸å…³è„šæœ¬ã€‚');
                console.warn('æç¤º: éœ€è¦å…ˆæ„å»ºé¡¹ç›®å¹¶å¼•å…¥ battle-demo.js');
                console.warn('æˆ–è€…åœ¨ index.html ä¸­ä½¿ç”¨æ­¤æ¼”ç¤ºé¡µé¢');
            } else {
                window.setStatus('success', 'âœ… å¤šåœºæˆ˜æ–—å¯¹æ¯”ç³»ç»Ÿå·²å°±ç»ªï¼ç‚¹å‡»æŒ‰é’®å¼€å§‹æ¼”ç¤ºã€‚');
            }
        });
    </script>

    <!-- æ³¨æ„ï¼šå®é™…ä½¿ç”¨æ—¶éœ€è¦å¼•å…¥ç¼–è¯‘åçš„ JS æ–‡ä»¶ -->
    <script type="module" src="./dist/test.js"></script>
</body>
</html>

