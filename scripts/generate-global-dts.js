#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

/**
 * 生成全局声明格式的 TypeScript 定义文件
 * 将 ES 模块格式转换为全局声明格式
 */

function generateGlobalDTS() {
    const inputFile = path.join(__dirname, '../build/fx/lib/index.d.ts');
    const outputFile = path.join(__dirname, '../build/fx/lib/index-global.d.ts');

    if (!fs.existsSync(inputFile)) {
        console.error('输入文件不存在:', inputFile);
        process.exit(1);
    }

    let content = fs.readFileSync(inputFile, 'utf8');

    // 添加文件头注释
    const header = `/** Declaration file generated by custom script */
`;

    // 移除 export 关键字，转换为全局声明
    content = content.replace(/^export declare /gm, 'declare ');
    content = content.replace(/^export /gm, '');

    // 添加全局模块声明
    const moduleDeclaration = `
declare module "fx" {
    ${content.split('\n').map(line => '    ' + line).join('\n')}
}

// 全局变量声明
declare global {
    const fx: typeof import("fx").fx;
    const FxCentre: typeof import("fx").FxCentre;
    const Folder: typeof import("fx").Folder;
    const Eve: typeof import("fx").Eve;
    const CallCenter: typeof import("fx").CallCenter;
    const MessageList: typeof import("fx").MessageList;
    const VariableValue: typeof import("fx").VariableValue;
    const Call: typeof import("fx").Call;
    const BasicBody: typeof import("fx").BasicBody;
    const SymbolBody: typeof import("fx").SymbolBody;
    const OperationBody: typeof import("fx").OperationBody;
    const Player: typeof import("fx").Player;
    const BillboardLayer: typeof import("fx").BillboardLayer;
    const ChartsLayer: typeof import("fx").ChartsLayer;
    const Bookmark: typeof import("fx").Bookmark;
    const FormulaData: typeof import("fx").FormulaData;
    const MetadataData: typeof import("fx").MetadataData;
    const OperationLayerData: typeof import("fx").OperationLayerData;
    const Message: typeof import("fx").Message;
    const NodeType: typeof import("fx").NodeType;
}
`;

    const finalContent = header + moduleDeclaration;

    // 确保输出目录存在
    const outputDir = path.dirname(outputFile);
    if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir, { recursive: true });
    }

    // 写入文件
    fs.writeFileSync(outputFile, finalContent, 'utf8');

    console.log('全局声明文件已生成:', outputFile);
    console.log('文件大小:', fs.statSync(outputFile).size, '字节');
}

// 运行脚本
if (require.main === module) {
    generateGlobalDTS();
}

module.exports = { generateGlobalDTS };

